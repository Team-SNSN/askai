#!/bin/bash
# askai wrapper - 실제 바이너리를 감싸는 스크립트
# 이 파일을 PATH에 설치하면 `askai "명령어"`로 사용 가능

# 실제 바이너리 경로 (개발 경로 우선)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [ -f "$SCRIPT_DIR/target/debug/askai" ]; then
    ASKAI_BIN="$SCRIPT_DIR/target/debug/askai"
elif [ -f "$SCRIPT_DIR/target/release/askai" ]; then
    ASKAI_BIN="$SCRIPT_DIR/target/release/askai"
elif [ -f "$HOME/.local/bin/askai-bin" ]; then
    ASKAI_BIN="$HOME/.local/bin/askai-bin"
elif command -v "askai-bin" &> /dev/null; then
    ASKAI_BIN="askai-bin"
else
    echo "❌ askai 바이너리를 찾을 수 없습니다." >&2
    echo "   먼저 'cargo build'를 실행하세요." >&2
    exit 1
fi

# 특별한 옵션들은 바이너리로 직접 전달
if [[ "$1" == "--help" ]] || [[ "$1" == "--version" ]] || \
   [[ "$1" == "--clear-cache" ]] || [[ "$1" == "--prewarm-cache" ]] || \
   [[ "$1" == "--daemon-start" ]] || [[ "$1" == "--daemon-stop" ]] || \
   [[ "$1" == "--daemon-status" ]] || [[ "$1" == "--batch" ]] || \
   [[ "$1" == "--debug" ]] || [[ "$1" == "-d" ]]; then
    exec "$ASKAI_BIN" "$@"
fi

# 일반 명령어 생성 및 실행
# 임시 파일을 사용하여 명령어 저장
TEMP_FILE=$(mktemp /tmp/askai.XXXXXX)

# 바이너리 실행 (사용자 확인 포함, stdin/stdout/stderr 모두 연결)
"$ASKAI_BIN" "$@" > "$TEMP_FILE"
exit_code=$?

if [ $exit_code -eq 0 ]; then
    # 사용자가 승인한 경우 명령어 읽기 및 실행
    cmd=$(cat "$TEMP_FILE")
    rm -f "$TEMP_FILE"

    if [ -n "$cmd" ]; then
        # 명령어 실행 (eval 사용)
        eval "$cmd"
    fi
else
    # 사용자가 취소했거나 에러가 발생한 경우
    rm -f "$TEMP_FILE"
    exit $exit_code
fi