#!/bin/bash

# askai wrapper script - 현재 터미널 세션에서 명령어 실행
#
# 사용법:
#   ai "현재 시간"
#   ai "src 디렉토리로 이동"
#
# 설치:
#   1. 이 파일을 PATH에 있는 디렉토리로 복사 (예: /usr/local/bin/ai)
#   2. 실행 권한 부여: chmod +x /usr/local/bin/ai

# askai 바이너리 경로 (필요시 수정)
# 개발 중인 경로를 우선적으로 사용
if [ -f "/Users/ys/Code/askai/target/debug/askai" ]; then
    ASKAI_BIN="/Users/ys/Code/askai/target/debug/askai"
elif [ -f "/Users/ys/Code/askai/target/release/askai" ]; then
    ASKAI_BIN="/Users/ys/Code/askai/target/release/askai"
elif command -v askai &> /dev/null; then
    ASKAI_BIN="askai"
else
    echo "❌ askai를 찾을 수 없습니다. 먼저 빌드해주세요." >&2
    echo "   cargo build --path /Users/ys/Code/askai" >&2
    exit 1
fi

# 인자가 없으면 도움말 출력
if [ $# -eq 0 ]; then
    echo "사용법: ai \"자연어 명령어\"" >&2
    echo "예시:" >&2
    echo "  ai \"현재 시간\"" >&2
    echo "  ai \"src 디렉토리로 이동\"" >&2
    echo "  ai \"모든 git 프로젝트 pull\"" >&2
    exit 1
fi

# askai를 실행하고 사용자 확인 후 eval로 실행
# 임시 파일을 사용하여 명령어 저장
TEMP_FILE=$(mktemp /tmp/askai.XXXXXX)

# 바이너리 실행 (사용자 확인 포함, stdin/stdout/stderr 모두 연결)
$ASKAI_BIN "$@" > "$TEMP_FILE"
exit_code=$?

if [ $exit_code -eq 0 ]; then
    # 사용자가 승인한 경우 명령어 읽기 및 실행
    cmd=$(cat "$TEMP_FILE")
    rm -f "$TEMP_FILE"

    if [ -n "$cmd" ]; then
        # 명령어 실행 (eval 사용)
        eval "$cmd"
    fi
else
    # 사용자가 취소했거나 에러가 발생한 경우
    rm -f "$TEMP_FILE"
    exit $exit_code
fi